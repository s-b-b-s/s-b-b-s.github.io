{"componentChunkName":"component---src-templates-blog-template-js","path":"/5-security-ssh-2/","result":{"data":{"cur":{"id":"913932ad-d047-50d6-91c9-e7e348cedeb0","html":"<h2 id=\"-소개\" style=\"position:relative;\"><a href=\"#-%EC%86%8C%EA%B0%9C\" aria-label=\" 소개 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 소개</h2>\n<p>SSH-KEY 접근을 중앙에서 관리해 보자🙌</p>\n<ul>\n<li>1 sshd_config 설정</li>\n<li>2 (client)api 요청 쉘스크립트 파일</li>\n<li>3 (server)api 응답 서버 코드</li>\n<li>4 ssh-key 중앙관리 플로우</li>\n</ul>\n<hr>\n<h3 id=\"️-1-sshd_config-설정\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-1-sshd_config-%EC%84%A4%EC%A0%95\" aria-label=\"️ 1 sshd_config 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 1. sshd_config 설정</h3>\n<blockquote>\n<p>/etc/ssh/sshd_conifg 설정 <br>\n설정은 아래 config에서 2개만 수정하면 된다<br></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">vi</span> /etc/ssh/sshd_config\n<span class=\"token comment\"># ssh-key로 접근시 api_key 파일을 실행하도록 설정한다</span>\nAuthorizedKeysCommand /usr/sbin/api_key\n\n<span class=\"token comment\"># AuthorizedKeysFile은 root권한만 수정이 가능한 디렉토리로 변경한다 </span>\nAuthorizedKeysFile /root/.ssh/authorized_keys\n</code></pre></div>\n<hr>\n<h3 id=\"️-2-usrsbinapi_key-쉘-스크립트-파일\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-2-usrsbinapi_key-%EC%89%98-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%ED%8C%8C%EC%9D%BC\" aria-label=\"️ 2 usrsbinapi_key 쉘 스크립트 파일 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 2. /usr/sbin/api_key 쉘 스크립트 파일</h3>\n<blockquote>\n<p>api를 호출하여 ssh-key를 받아온다 <br></p>\n<ul>\n<li>변수<code class=\"language-text\">$1</code>은 접근시도한 계정명을 가져올수 있다<br></li>\n</ul>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># sh-key api 호출</span>\n<span class=\"token function\">vi</span> /etc/sbin/api_key\n\n<span class=\"token comment\">#!/bin/bash</span>\n\n<span class=\"token function\">curl</span> http://localhost:8081/sshkey/<span class=\"token variable\">$1</span></code></pre></div>\n<hr>\n<h3 id=\"️-3-api-서버-코드\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-3-api-%EC%84%9C%EB%B2%84-%EC%BD%94%EB%93%9C\" aria-label=\"️ 3 api 서버 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 3. api 서버 코드</h3>\n<blockquote>\n<p>간단하게 ssh-key만 리턴하는 코드임<br></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"log\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\thttp<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sshkey\"</span><span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">ListenAndServe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"8081\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Fprint</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ssh-rsa AAAAB3NzaC1y~~ ec2-user@ip-172-31-00-00.ap-northeast-2.compute.internal\"</span><span class=\"token punctuation\">)</span>\n\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 계정명 </span>\n<span class=\"token punctuation\">}</span>\n\n</code></pre></div>\n<hr>\n<h3 id=\"️-4-ssh-key-중앙관리-플로우\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-4-ssh-key-%EC%A4%91%EC%95%99%EA%B4%80%EB%A6%AC-%ED%94%8C%EB%A1%9C%EC%9A%B0\" aria-label=\"️ 4 ssh key 중앙관리 플로우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 4. ssh-key 중앙관리 플로우</h3>\n<blockquote>\n<p>사용자는 미리 ssh 중앙관리 서버에 <code class=\"language-text\">srcIP</code>,<code class=\"language-text\">dstIP</code>,<code class=\"language-text\">ssh-key</code>,<code class=\"language-text\">계정</code> 4가지를  정책으로 넣어두고 <br>\nsource와 dest IP,접근하는 계정이 DB에 있으면 <code class=\"language-text\">200, ssh-key</code>를 리턴해서 접근은 <strong>성공</strong>한다<br>\nsource와 dest IP,접근하는 계정이 DB에 없으면 <code class=\"language-text\">400</code>을 리턴해고 ssh-key접근을 <strong>실패</strong>한다<br>\n아래 플로우로 SSH-KEY를 중앙관리를 할 수 있다<br></p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACK0lEQVQ4y5WT22/TMBTG82/zzhtPICH2gNBAGuVaDY0hHihQTaAC6qC3rZd0bbcmcZq2SVMnTmInH4q7VukaJnGkyMf2yU+fPx8ryIkkSa7HGEKIrbVsznmUTrbWlDzYenOsm2i0OgjDcLMXx/EKJgQ6vSH6F6OMgCQfmEaq7PuvJh7sPcHFYIggCDAaXWI8HiMMAxjEwtujEvYPXiAMo21gVlU2P6nUcffefeiGsVG1VuizEAevj/Ho8f5mTQLXgJvQtYfZ4pvheR5c190SouQdNy/Pzh3HgTmZwLZtCc2G4iyW+HnaQuuss/XzBpIB+R5FwHwgVS44GGMSalkWCCHgnEM5a/ex9/QNyrUezOk8t4VMh+NqJqDqFAPCoM0FiCPg+QyUUlmXWiOPbBAThx+/4LiqQr3U5SYLAnkUwTkikaBrCLR1gebAxWl3inMtQs8EZgtfqs7tQ0JMUM+T8g3DgKbpcBwb1A/Q1hj+qDZKJ1UUXhVRaWpojjyMyQz+tYcbYJoIkd6mkL2X+pCOIk59EqB+KIGNIUWh+Al3HhbwuTnB+RWDZVPp58rqDPC2CHkClXD0JwlqFwt8qI7xrWWi2pli6e8+SyXvZrNtEkQxekaEHhGoNHSUf3RRU22p2PX4Tlsp/1KWBaYK21qI4vsynj0/RL1vo28Brs/zFd4GDPlKYccQOCr9xst3X1EfLOWcMvF/wHXdkgnMlgK2l2BOY/k5nth5qinwL89Hzp6xvSOAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"사진2\"\n        title=\"사진2\"\n        src=\"/static/9a93cdfc87337e2bd2c93784ada059b8/37523/2.png\"\n        srcset=\"/static/9a93cdfc87337e2bd2c93784ada059b8/e9ff0/2.png 180w,\n/static/9a93cdfc87337e2bd2c93784ada059b8/f21e7/2.png 360w,\n/static/9a93cdfc87337e2bd2c93784ada059b8/37523/2.png 720w,\n/static/9a93cdfc87337e2bd2c93784ada059b8/302a4/2.png 1080w,\n/static/9a93cdfc87337e2bd2c93784ada059b8/21482/2.png 1350w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"참고사이트\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0%EC%82%AC%EC%9D%B4%ED%8A%B8\" aria-label=\"참고사이트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고사이트</h3>\n<blockquote>\n<p><a href=\"https://www.popit.kr/ssh-key-%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9D%B8-%EA%B4%80%EB%A6%AC-%EB%B0%A9%EB%B2%95/\">https://www.popit.kr/ssh-key-%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9D%B8-%EA%B4%80%EB%A6%AC-%EB%B0%A9%EB%B2%95/</a></p>\n</blockquote>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EC%86%8C%EA%B0%9C\">👋 소개</a></p>\n<ul>\n<li><a href=\"#%EF%B8%8F-1-sshd_config-%EC%84%A4%EC%A0%95\">⌨️ 1. sshd_config 설정</a></li>\n<li><a href=\"#%EF%B8%8F-2-usrsbinapi_key-%EC%89%98-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%ED%8C%8C%EC%9D%BC\">⌨️ 2. /usr/sbin/api_key 쉘 스크립트 파일</a></li>\n<li><a href=\"#%EF%B8%8F-3-api-%EC%84%9C%EB%B2%84-%EC%BD%94%EB%93%9C\">⌨️ 3. api 서버 코드</a></li>\n<li><a href=\"#%EF%B8%8F-4-ssh-key-%EC%A4%91%EC%95%99%EA%B4%80%EB%A6%AC-%ED%94%8C%EB%A1%9C%EC%9A%B0\">⌨️ 4. ssh-key 중앙관리 플로우</a></li>\n<li><a href=\"#%EC%B0%B8%EA%B3%A0%EC%82%AC%EC%9D%B4%ED%8A%B8\">참고사이트</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"👋 소개 SSH-KEY 접근을 중앙에서 관리해 보자🙌 1 sshd_config 설정 2 (client)api 요청 쉘스크립트 파일 3 (server)api 응답 서버 코드 4 ssh-key 중앙관리 플로우 ⌨️ 1. sshd_config 설정 /etc/ssh/sshd_conifg 설정 \n설정은 아래 config에서 2개만 수정하면 된다 ⌨️ 2. /usr/sbin/api_key 쉘 스크립트 파일 api를 호출하여 ssh-key를 받아온다  변수은 접근시도한 계정명을 가져올수 있다 ⌨️ 3. api 서버 코드 간단하게 ssh-key만 리턴하는 코드임 ⌨️ 4. ssh-key 중앙관리 플로우 사용자는 미리 ssh 중앙관리 서버에 ,,, 4가지를  정책으로 넣어두고 \nsource와 dest IP,접근하는 계정이 DB에 있으면 를 리턴해서 접근은 성공한다\nsource와 dest IP,접근하는 계정이 DB에 없으면 을 리턴해고 ssh-key접근을 실패한다\n아래 플로우로 SSH-KEY를 중앙관리를 …","frontmatter":{"date":"June 05, 2023","title":"[보안] SSH 접근 중앙관리 - SSH-KEY 관리 (2)","categories":"보안","author":"sb","emoji":"🔐"},"fields":{"slug":"/5-security-ssh-2/"}},"next":{"id":"14ecab48-f067-5833-832e-13cde7c7664b","html":"<h2 id=\"-소개\" style=\"position:relative;\"><a href=\"#-%EC%86%8C%EA%B0%9C\" aria-label=\" 소개 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 소개</h2>\n<p>SSH 접근을 중앙에서 관리해 보자🙌</p>\n<ul>\n<li>1 pam 설정</li>\n<li>2 (client)api 요청 쉘파일 설정</li>\n<li>3 (server)api 응답 서버 코드</li>\n<li>4 ssh 중앙관리 플로우</li>\n</ul>\n<hr>\n<h3 id=\"️-1-pam-설정\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-1-pam-%EC%84%A4%EC%A0%95\" aria-label=\"️ 1 pam 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 1. pam 설정</h3>\n<blockquote>\n<p>pam(Pluggable Authentication Module)은 사용 권한을 제어하는 모듈이다<br></p>\n<ul>\n<li>1번째 인자 <code class=\"language-text\">session</code>은 sshd 세션을 열었을때 옵션이다 <br></li>\n<li>2번째 인자 <code class=\"language-text\">required</code> - 해당 설정으로 진행 시 실패하면 인증을 거부한다 <br></li>\n<li>2번째 인자 <code class=\"language-text\">optional</code> - 해당 설정으로 진행 시 실패해도 인증은 성공한다 <br></li>\n<li>3번째 인자 <code class=\"language-text\">pam_exec.so</code> 는 내가 지정한 파일을 실행시키는 옵션이다 <br></li>\n<li>4번째 인자 <code class=\"language-text\">/etc/ssh.sh</code> 는 내가 지정한 파일의 경로이다 <br></li>\n</ul>\n<p>/etc/pam.d/sshd 설정 <br></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">vi</span> /etc/pam.d/sshd\n<span class=\"token comment\"># 맨마지막 줄에 아래 옵션을 추가한다 (잘못설정하면 영영 ssh접근이안되니.. 테스트는 optional로)</span>\nsession optional pam_exec.so /etc/ssh.sh\n</code></pre></div>\n<hr>\n<h3 id=\"️-2-etcsshsh-api-설정\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-2-etcsshsh-api-%EC%84%A4%EC%A0%95\" aria-label=\"️ 2 etcsshsh api 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 2. /etc/ssh.sh api 설정</h3>\n<blockquote>\n<p>exit code <code class=\"language-text\">0</code>은 정상 종료, exit code <code class=\"language-text\">1</code>은 에러 비정상종료 <br></p>\n<ul>\n<li><code class=\"language-text\">$PAM_RHOST</code>는 접근시도한 Remote 호스트<br></li>\n<li><code class=\"language-text\">$PAM_USER</code>는 접근하려는 User 값을 받아올수있다 <br></li>\n</ul>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># api로 로그인 성공 api 호출</span>\n<span class=\"token function\">vi</span> /etc/ssh.sh\n\n\n<span class=\"token comment\">#!/bin/bash</span>\n<span class=\"token assign-left variable\">STATUS</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-o</span> /dev/null <span class=\"token parameter variable\">-w</span> <span class=\"token string\">\"%{http_code}\"</span> <span class=\"token string\">\"http://localhost:8089/api1/<span class=\"token variable\">$PAM_RHOST</span>/<span class=\"token variable\">$PAM_USER</span>\"</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$STATUS</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"로그인 성공\"</span>\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"로그인 실패\"</span>\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<hr>\n<h3 id=\"️-3-api-서버-코드\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-3-api-%EC%84%9C%EB%B2%84-%EC%BD%94%EB%93%9C\" aria-label=\"️ 3 api 서버 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 3. api 서버 코드</h3>\n<blockquote>\n<p><strong>api 1</strong>은 response code <code class=\"language-text\">200</code>, <strong>api 2</strong>는 response code <code class=\"language-text\">400</code>을 준다<br></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"log\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\thttp<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api1\"</span><span class=\"token punctuation\">,</span> index1<span class=\"token punctuation\">)</span>\n\thttp<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api2\"</span><span class=\"token punctuation\">,</span> index2<span class=\"token punctuation\">)</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">ListenAndServe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":8089\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">index1</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    sourceip <span class=\"token operator\">:=</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">Split</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>RemoteAddr<span class=\"token punctuation\">,</span> <span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Source IP \"</span><span class=\"token punctuation\">,</span>sourceip<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Destination IP \"</span><span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"사용자\"</span><span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\tw<span class=\"token punctuation\">.</span><span class=\"token function\">WriteHeader</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">StatusText</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">index2</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    sourceip <span class=\"token operator\">:=</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">Split</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>RemoteAddr<span class=\"token punctuation\">,</span> <span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Source IP \"</span><span class=\"token punctuation\">,</span>sourceip<span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Destination IP \"</span><span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"사용자\"</span><span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\tw<span class=\"token punctuation\">.</span><span class=\"token function\">WriteHeader</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">StatusText</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<hr>\n<h3 id=\"️-4-ssh-중앙관리-플로우\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-4-ssh-%EC%A4%91%EC%95%99%EA%B4%80%EB%A6%AC-%ED%94%8C%EB%A1%9C%EC%9A%B0\" aria-label=\"️ 4 ssh 중앙관리 플로우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 4. ssh 중앙관리 플로우</h3>\n<blockquote>\n<p>사용자는 미리 ssh 중앙관리 서버에 source,dest IP를 api서버에 정책으로 넣어두고 <br>\nsource와 dest IP가 DB에 있으면 <code class=\"language-text\">200</code>을 리턴해서 접근성공 <br>\nsource와 dest IP가 DB에 없으면 <code class=\"language-text\">400</code>을 리턴해서 접근실패<br>\n아래 플로우로 SSH 중앙관리를 할 수 있다<br></p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACDElEQVQ4y52Tz2/TMBzF+39z44bggoQ4gISYNMEBiU1cKBpsjF8bpbSrCk27rfRX0jS0zU8ndpw4D9ldIGvTHbBkOXacT977+rmCkpZlmRo9z0Mcx2VbQCmF63rX9stW2QZjLEat8RO1elMughACx3HUD9I0gXY+xNHHU7Ve/G4rkIQMj3Ze4t79B2ruui4sy0JEKTiPUT2s4dbtOzBnM/VeCLECSkDei0AhMjRaHTRb7VLLo4mJg8NjsKuSlCpch+ZNwvM1WTtCQpAgQByzDXcVzhNMzd/K0jpU2sitIBNIEw5GI5DAh2PbsG0bvu+rw4uiaKVwMDLwfO8Nvp51wDn/C8tFpiKDTwWWPsPIWCBgGUgMxDxRIiRMjmEYroCX/QEeP9tH9WyIkfGvwLlSO0ihGQm6BoemM3SnCbqmgD6PQKNw0/LqRCNcjqcII6qiYRhTzCwLmUix8FP0TIFmz0L17QccnbSh6Ry/DA8hCQqOioeSZUh4rDImi84YU6MsujEn+DGmeH/aw92HO3jyugZtwtDXHXDONoNdjE3xRf648BP0zBQ9neLVlwvs10Zo9BbQF7Q0EZWi5DJ4DuxMInxqDPFds1A/t68Bb7x665mcewkuLOCkNcbT3T28+9zGYAnMnGS7wpuAy0AqzPCtO8fuiwMc1/tqPnP4/wFlDh2Swg3FVV/Nk7T8Vv0BrheCaqxkHgIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"사진1\"\n        title=\"사진1\"\n        src=\"/static/acdd72eead2f01abc53ab46504fdc3aa/37523/1.png\"\n        srcset=\"/static/acdd72eead2f01abc53ab46504fdc3aa/e9ff0/1.png 180w,\n/static/acdd72eead2f01abc53ab46504fdc3aa/f21e7/1.png 360w,\n/static/acdd72eead2f01abc53ab46504fdc3aa/37523/1.png 720w,\n/static/acdd72eead2f01abc53ab46504fdc3aa/302a4/1.png 1080w,\n/static/acdd72eead2f01abc53ab46504fdc3aa/bb543/1.png 1418w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"참고사이트\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0%EC%82%AC%EC%9D%B4%ED%8A%B8\" aria-label=\"참고사이트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고사이트</h3>\n<blockquote>\n<p><a href=\"https://wariua.github.io/linux-pam-docs-ko/sag-pam_exec.html\">https://wariua.github.io/linux-pam-docs-ko/sag-pam_exec.html</a></p>\n</blockquote>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EC%86%8C%EA%B0%9C\">👋 소개</a></p>\n<ul>\n<li><a href=\"#%EF%B8%8F-1-pam-%EC%84%A4%EC%A0%95\">⌨️ 1. pam 설정</a></li>\n<li><a href=\"#%EF%B8%8F-2-etcsshsh-api-%EC%84%A4%EC%A0%95\">⌨️ 2. /etc/ssh.sh api 설정</a></li>\n<li><a href=\"#%EF%B8%8F-3-api-%EC%84%9C%EB%B2%84-%EC%BD%94%EB%93%9C\">⌨️ 3. api 서버 코드</a></li>\n<li><a href=\"#%EF%B8%8F-4-ssh-%EC%A4%91%EC%95%99%EA%B4%80%EB%A6%AC-%ED%94%8C%EB%A1%9C%EC%9A%B0\">⌨️ 4. ssh 중앙관리 플로우</a></li>\n<li><a href=\"#%EC%B0%B8%EA%B3%A0%EC%82%AC%EC%9D%B4%ED%8A%B8\">참고사이트</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"June 04, 2023","title":"[보안] SSH 접근 중앙관리 - pam 설정(1)","categories":"보안","author":"sb","emoji":"🔐"},"fields":{"slug":"/5-security-ssh-1/"}},"prev":{"id":"f8f08c61-69a2-50e5-9f39-cc0f4160e85c","html":"<h2 id=\"-소개\" style=\"position:relative;\"><a href=\"#-%EC%86%8C%EA%B0%9C\" aria-label=\" 소개 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👋 소개</h2>\n<p>SSH-CERT 접근을 중앙에서 관리해 보자🙌<br></p>\n<p><strong>🔵 SSH-KEY 보다 SSH-CERT를 사용해야하는 4가지</strong> <br></p>\n<ul>\n<li>1 프로비저닝하거나 <code class=\"language-text\">프로비저닝 해제할 필요</code>가 없음</li>\n<li>2 인증서는 실제로 <code class=\"language-text\">단 한 줄</code>의 코드로 구현하기가 매우 간단함</li>\n<li>3 수명이 짧고 자체 파괴적이므로 자동으로 <code class=\"language-text\">기한 만료</code>됨</li>\n<li>4 key는 사용자가 생성 및 관리를 하지만 cert는 <code class=\"language-text\">CISO가 관리</code>를 할 수 있음</li>\n</ul>\n<p><strong>🔴 많은 기업들이 SSH-KEY를 사용하지 않는 이유 3가지</strong> <br></p>\n<ul>\n<li>1 <code class=\"language-text\">잘못된 PR</code> : 조직에서 인증서를 사용하도록 하는 데 충분한 추진력이 없음</li>\n<li>(Facebook, Uber, Netflix, Lyft 등이 SSH 인증서를 채택했지만 좋은 PR은 아직 나오지 않음)</li>\n<li>2 <code class=\"language-text\">PKI 지식 필요</code> : 이 작업을 수행하려면 약간의 PKI 지식이 필요</li>\n<li>3 <code class=\"language-text\">인프라 설정 필요</code> : SSH 인증서는 생각보다 어렵지 않지만 먼저 일부 구성을 수행해야 함</li>\n</ul>\n<p><strong>🟡 순서</strong> <br></p>\n<ul>\n<li>1 ssh-keygen으로 CA인증서 생성<code class=\"language-text\">(중앙서버)</code></li>\n<li>2 sshd_config 설정 및 키파일 전송<code class=\"language-text\">(목적지서버)</code></li>\n<li>3 ssh-keygen으로 sign받을 키페어 생성 <code class=\"language-text\">(출발지서버)</code></li>\n<li>4 CA인증서로 키페어 sign<code class=\"language-text\">(중앙서버)</code></li>\n<li>5 sign된 키로 목적지 서버에 ssh 접속<code class=\"language-text\">(출발지서버)</code></li>\n<li>6 ssh-cert 중앙관리 플로우</li>\n</ul>\n<hr>\n<h3 id=\"️-1-ssh-keygen으로-ca인증서-생성중앙서버\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-1-ssh-keygen%EC%9C%BC%EB%A1%9C-ca%EC%9D%B8%EC%A6%9D%EC%84%9C-%EC%83%9D%EC%84%B1%EC%A4%91%EC%95%99%EC%84%9C%EB%B2%84\" aria-label=\"️ 1 ssh keygen으로 ca인증서 생성중앙서버 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 1. ssh-keygen으로 CA인증서 생성(중앙서버)</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">#passphrase는 없이 생성한다</span>\nssh-keygen <span class=\"token parameter variable\">-f</span> client_ca\n<span class=\"token comment\"># client_ca, client_ca.pub 파일이 생성된다</span></code></pre></div>\n<hr>\n<h3 id=\"️-2-sshd_config-설정-및-키파일-전송목적지서버\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-2-sshd_config-%EC%84%A4%EC%A0%95-%EB%B0%8F-%ED%82%A4%ED%8C%8C%EC%9D%BC-%EC%A0%84%EC%86%A1%EB%AA%A9%EC%A0%81%EC%A7%80%EC%84%9C%EB%B2%84\" aria-label=\"️ 2 sshd_config 설정 및 키파일 전송목적지서버 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 2. sshd_config 설정 및 키파일 전송(목적지서버)</h3>\n<blockquote>\n<p>/etc/ssh/sshd_conifg 설정 <br>\n설정 이후 sshd 서비스 재시작 필요<br>\n<code class=\"language-text\">이 키로부터 사인된 인증서로 접근하는 클라이언트라면 SSH 접근을 허용한다</code>라는 의미임 <br></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">vi</span> /etc/ssh/sshd_config\n<span class=\"token comment\"># 중앙서버에서 생성한 client_ca.pub 파일을 목적지 서버로 가져와서 세팅한다</span>\nTrustedUserCAKeys /etc/ssh/client_ca.pub\n</code></pre></div>\n<hr>\n<h3 id=\"️-3-ssh-keygen으로-sign받을-키페어-생성-출발지서버\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-3-ssh-keygen%EC%9C%BC%EB%A1%9C-sign%EB%B0%9B%EC%9D%84-%ED%82%A4%ED%8E%98%EC%96%B4-%EC%83%9D%EC%84%B1-%EC%B6%9C%EB%B0%9C%EC%A7%80%EC%84%9C%EB%B2%84\" aria-label=\"️ 3 ssh keygen으로 sign받을 키페어 생성 출발지서버 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 3. ssh-keygen으로 sign받을 키페어 생성 (출발지서버)</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">#passphrase는 없이 생성한다</span>\nssh-keygen\n<span class=\"token comment\"># id_rsa, id_rsa.pub 파일이 생성된다</span></code></pre></div>\n<hr>\n<h3 id=\"️-4-ca인증서로-키페어-sign중앙서버\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-4-ca%EC%9D%B8%EC%A6%9D%EC%84%9C%EB%A1%9C-%ED%82%A4%ED%8E%98%EC%96%B4-sign%EC%A4%91%EC%95%99%EC%84%9C%EB%B2%84\" aria-label=\"️ 4 ca인증서로 키페어 sign중앙서버 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 4. CA인증서로 키페어 sign(중앙서버)</h3>\n<blockquote>\n<p>출발지 서버에서 id_rsa.pub 파일을 가져온다 <br>\n기존에 만든 client_ca인증서로 sign을 한다 <br></p>\n<ul>\n<li>옵션 -n : 계정명 <br></li>\n<li>옵션 -V : 사용기간 <br></li>\n</ul>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ssh-keygen <span class=\"token parameter variable\">-s</span> client_ca <span class=\"token parameter variable\">-I</span> user_identifier <span class=\"token parameter variable\">-n</span> root <span class=\"token parameter variable\">-V</span> +5m id_rsa.pub\n<span class=\"token comment\">#  id_rsa-cert.pub 파일이 생성된다</span></code></pre></div>\n<hr>\n<h3 id=\"️-5-sign된-키로-목적지-서버에-ssh-접속출발지서버\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-5-sign%EB%90%9C-%ED%82%A4%EB%A1%9C-%EB%AA%A9%EC%A0%81%EC%A7%80-%EC%84%9C%EB%B2%84%EC%97%90-ssh-%EC%A0%91%EC%86%8D%EC%B6%9C%EB%B0%9C%EC%A7%80%EC%84%9C%EB%B2%84\" aria-label=\"️ 5 sign된 키로 목적지 서버에 ssh 접속출발지서버 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 5. sign된 키로 목적지 서버에 ssh 접속(출발지서버)</h3>\n<blockquote>\n<p>중앙서버에서 발급한 id_rsa-cert.pub키를 ~/.ssh/id_rsa-cert.pub 로 위치시킨다<br></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ssh</span> 계정명@목적지서버\n<span class=\"token comment\">#접속성공</span></code></pre></div>\n<hr>\n<h3 id=\"️-6-ssh-cert-중앙관리-플로우\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-6-ssh-cert-%EC%A4%91%EC%95%99%EA%B4%80%EB%A6%AC-%ED%94%8C%EB%A1%9C%EC%9A%B0\" aria-label=\"️ 6 ssh cert 중앙관리 플로우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⌨️ 6. ssh-cert 중앙관리 플로우</h3>\n<blockquote>\n<p>보안 담당자는 는 미리 ssh-cert 중앙관리 서버에 <code class=\"language-text\">CA인증서</code>를 생성해둔다 <br>\n인프라 담당자는 미리 모든 서버에 <code class=\"language-text\">CA키</code>, <code class=\"language-text\">TrustedUserCAKeys</code> 세팅해 논다<br>\n사용자는 ssh접속이 필요할경우 <code class=\"language-text\">키페어</code>를 생성해 <code class=\"language-text\">signing요청</code>을 하고 ssh접속을 한다<br></p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACJklEQVQ4y5WSTW8SURSG+dtuTLrrUreaaFzUmmhcqKuakNrWWhNrm1ILDDCAQOcLZphvmK/H3EuGYjuN9SQnd+C+ec57zrk1KiJJEmzb4b4Q97OZvf5dFMX6u5ZlGcvlUorEuVgsUHoj9upHmJYlRVEU4XmePKGg2x9TPzhhNJ7cBfq+z/X1NZZloes6k8mY+tEZj7a2+Xl+LtQYhiE1wnUcRxyeNNjafsLh8TcJyfP8BljV0sVVl2cvd9B0vbJldajx/NUu3Z66BgqXImvlh8iyUlHcVBT/bWbZXpIs77S7drgJFSFmGccLigp3q8IFYRiui4g9iJQO7wOKLO9Mw2DQ72NZZoklCALm87mcrWmacs5isbXblkWIaqKlmZ8xtBJ6WoQyDuQ5nKaYbio3Xrr7a4bls7BtW1YU6dg2fhChmjltLefXMOC8M+VqFKPoOR09xfPDyoVJoHh7juPgui6u6zG1LOauj2okNCdLvp4qvH7zlv3vTbomtCcRcy/g9rjWW66KMIpp/g5oDAI+fv7B46cv2D1ooWgZzVFIEC0etuWVoCDLC1Qzo2sUXA5DduoN3h+1OW1POetMSdL8fuDmkygFaZbLlltaxkCL6Q0cmqOIi77H5cBlmWT/Bm4KBLCnJwxmsHfS5sOXT7SGDh1j5fxBDm8Du3qCauTsKy7vTlUaik5Ly+loyf8BV5oCy03pGQnjaYY2y+mbiRyDMU/lfVEB/AMces9LEraQVwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"사진1\"\n        title=\"사진1\"\n        src=\"/static/a6923deb2064110af7a86628da5c0531/37523/1.png\"\n        srcset=\"/static/a6923deb2064110af7a86628da5c0531/e9ff0/1.png 180w,\n/static/a6923deb2064110af7a86628da5c0531/f21e7/1.png 360w,\n/static/a6923deb2064110af7a86628da5c0531/37523/1.png 720w,\n/static/a6923deb2064110af7a86628da5c0531/302a4/1.png 1080w,\n/static/a6923deb2064110af7a86628da5c0531/07a9c/1.png 1440w,\n/static/a6923deb2064110af7a86628da5c0531/bd9eb/1.png 1442w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"참고사이트\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0%EC%82%AC%EC%9D%B4%ED%8A%B8\" aria-label=\"참고사이트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고사이트</h3>\n<blockquote>\n<p><a href=\"https://www.devseccon.com/blog/3-reasons-to-use-ssh-certificates-instead-of-ssh-keys-secadvent-day-22\">https://www.devseccon.com/blog/3-reasons-to-use-ssh-certificates-instead-of-ssh-keys-secadvent-day-22</a><br>\n<a href=\"https://blog.naver.com/alice_k106/221803861645\">https://blog.naver.com/alice_k106/221803861645</a></p>\n</blockquote>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EC%86%8C%EA%B0%9C\">👋 소개</a></p>\n<ul>\n<li><a href=\"#%EF%B8%8F-1-ssh-keygen%EC%9C%BC%EB%A1%9C-ca%EC%9D%B8%EC%A6%9D%EC%84%9C-%EC%83%9D%EC%84%B1%EC%A4%91%EC%95%99%EC%84%9C%EB%B2%84\">⌨️ 1. ssh-keygen으로 CA인증서 생성(중앙서버)</a></li>\n<li><a href=\"#%EF%B8%8F-2-sshd_config-%EC%84%A4%EC%A0%95-%EB%B0%8F-%ED%82%A4%ED%8C%8C%EC%9D%BC-%EC%A0%84%EC%86%A1%EB%AA%A9%EC%A0%81%EC%A7%80%EC%84%9C%EB%B2%84\">⌨️ 2. sshd_config 설정 및 키파일 전송(목적지서버)</a></li>\n<li><a href=\"#%EF%B8%8F-3-ssh-keygen%EC%9C%BC%EB%A1%9C-sign%EB%B0%9B%EC%9D%84-%ED%82%A4%ED%8E%98%EC%96%B4-%EC%83%9D%EC%84%B1-%EC%B6%9C%EB%B0%9C%EC%A7%80%EC%84%9C%EB%B2%84\">⌨️ 3. ssh-keygen으로 sign받을 키페어 생성 (출발지서버)</a></li>\n<li><a href=\"#%EF%B8%8F-4-ca%EC%9D%B8%EC%A6%9D%EC%84%9C%EB%A1%9C-%ED%82%A4%ED%8E%98%EC%96%B4-sign%EC%A4%91%EC%95%99%EC%84%9C%EB%B2%84\">⌨️ 4. CA인증서로 키페어 sign(중앙서버)</a></li>\n<li><a href=\"#%EF%B8%8F-5-sign%EB%90%9C-%ED%82%A4%EB%A1%9C-%EB%AA%A9%EC%A0%81%EC%A7%80-%EC%84%9C%EB%B2%84%EC%97%90-ssh-%EC%A0%91%EC%86%8D%EC%B6%9C%EB%B0%9C%EC%A7%80%EC%84%9C%EB%B2%84\">⌨️ 5. sign된 키로 목적지 서버에 ssh 접속(출발지서버)</a></li>\n<li><a href=\"#%EF%B8%8F-6-ssh-cert-%EC%A4%91%EC%95%99%EA%B4%80%EB%A6%AC-%ED%94%8C%EB%A1%9C%EC%9A%B0\">⌨️ 6. ssh-cert 중앙관리 플로우</a></li>\n<li><a href=\"#%EC%B0%B8%EA%B3%A0%EC%82%AC%EC%9D%B4%ED%8A%B8\">참고사이트</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"June 06, 2023","title":"[보안] SSH 접근 중앙관리 - SSH-Cert 관리 (3)","categories":"보안","author":"sb","emoji":"🔐"},"fields":{"slug":"/5-security-ssh-3/"}},"site":{"siteMetadata":{"siteUrl":"https://sbbs.me","comments":{"utterances":{"repo":""}}}}},"pageContext":{"slug":"/5-security-ssh-2/","nextSlug":"/5-security-ssh-1/","prevSlug":"/5-security-ssh-3/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}